<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é£Ÿç‰©å åœ ï¿½</title>
  <style>
    /* æº«é¦¨æ‰‹ç¹ªé¢¨æ ¼å»¶çºŒï¼šç±³é»ƒå’–å•¡æ¼¸ + æš–æ£•æ¼¸å±¤ */
    body {
      margin: 0;
      padding: 0;
      font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: #faf4ed url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 100 100"><circle cx="25" cy="25" r="10" fill="%23d7ccc8"/><circle cx="75" cy="35" r="15" fill="%23bcaaa4"/><circle cx="55" cy="75" r="12" fill="%23d7ccc8"/></svg>') repeat;
      background-size: 100px;
      color: #5d4037;
      min-height: 100vh;
      position: relative;
      overflow-x: auto;
    }

    /* èƒŒæ™¯æº«æŸ”é£„æµ®è£é£¾ */
    .deco {
      position: fixed;
      font-size: 3.5em;
      opacity: 0.12;
      pointer-events: none;
      animation: gentleFloat 25s infinite linear;
      z-index: 1;
    }
    .deco1 { top: 10%; left: 5%; animation-delay: 0s; }
    .deco2 { top: 20%; right: 8%; animation-delay: 7s; }
    .deco3 { bottom: 25%; left: 6%; animation-delay: 14s; }
    .deco4 { bottom: 12%; right: 5%; animation-delay: 20s; }
    @keyframes gentleFloat {
      0% { transform: translateY(0) rotate(0deg) scale(1); }
      100% { transform: translateY(-120vh) rotate(180deg) scale(1.1); }
    }

    .main-container {
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .container {
      max-width: 850px;
      width: 95%;
      background: rgba(255, 255, 252, 0.95);
      border-radius: 32px;
      padding: 50px 40px;
      box-shadow: 
        0 20px 50px rgba(161, 117, 87, 0.25),
        inset 0 0 30px rgba(255, 240, 220, 0.5);
      text-align: center;
      backdrop-filter: blur(15px);
      margin-bottom: 30px;
    }

    /* æ¨™é¡Œæº«æš–æ‰‹å¯« */
    h1 {
      font-size: 3em;
      margin: 0 0 12px;
      background: linear-gradient(135deg, #8d5524, #c68642, #ffab40);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
      letter-spacing: 2px;
      text-shadow: 0 3px 6px rgba(198, 134, 66, 0.2);
    }

    .subtitle {
      font-size: 1.25em;
      color: #8d5524;
      margin-bottom: 35px;
      opacity: 0.9;
    }

    /* è¼¸å…¥ + ç¯©é¸å™¨å€ */
    .search-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin: 35px 0;
      padding: 25px;
      background: rgba(255, 240, 220, 0.4);
      border-radius: 25px;
      box-shadow: inset 0 4px 15px rgba(255, 204, 128, 0.2);
    }

    .input-group, .filter-group {
      flex: 1;
      min-width: 280px;
      text-align: left;
    }

    label {
      display: block;
      font-size: 1.15em;
      margin-bottom: 12px;
      color: #6d4c41;
      font-weight: 500;
    }

    input[type="text"], select {
      width: 100%;
      padding: 16px 22px;
      border: 2px solid #d7ccc8;
      border-radius: 25px;
      font-size: 1.1em;
      background: rgba(255, 255, 255, 0.8);
      box-sizing: border-box;
      transition: all 0.3s;
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #ffab40;
      box-shadow: 0 0 20px rgba(255, 171, 64, 0.3);
      transform: scale(1.02);
    }

    /* æŸ¥è©¢æŒ‰éˆ• */
    .btn {
      display: inline-block;
      padding: 18px 35px;
      background: linear-gradient(to bottom, #ffcc80, #ffab40);
      color: #5d4037;
      font-size: 1.35em;
      font-weight: bold;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 28px rgba(255, 171, 64, 0.4);
      transition: all 0.4s ease;
      margin: 0 10px;
    }

    .btn:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 15px 40px rgba(255, 171, 64, 0.5);
    }

    .btn:active { transform: translateY(0); }

    /* çµæœè¡¨æ ¼ï¼šå¡ç‰‡å †ç–Šé¢¨ */
    .records {
      margin-top: 45px;
    }

    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      font-size: 1.1em;
      color: #8d5524;
    }

    .record-count {
      background: rgba(255, 204, 128, 0.3);
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 15px;
    }

    th {
      background: linear-gradient(to right, rgba(255, 204, 128, 0.4), rgba(255, 171, 64, 0.3));
      padding: 18px 20px;
      color: #8d5524;
      font-weight: 600;
      border-radius: 15px 15px 0 0;
    }

    td {
      background: rgba(255, 255, 255, 0.75);
      padding: 20px 22px;
      box-shadow: 0 6px 18px rgba(161, 117, 87, 0.12);
      transition: all 0.3s;
    }

    tr:hover td {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(161, 117, 87, 0.2);
      background: rgba(255, 255, 255, 0.9);
    }

    tr td:first-child { border-radius: 15px 0 0 15px; }
    tr td:last-child { border-radius: 0 15px 15px 0; }

    /* ç„¡ç´€éŒ„æº«é¦¨æç¤º */
    .no-record {
      text-align: center;
      font-size: 1.3em;
      color: #a1887f;
      margin: 50px 0;
      padding: 45px 30px;
      background: linear-gradient(135deg, rgba(255, 240, 220, 0.6), rgba(255, 204, 128, 0.3));
      border-radius: 25px;
      box-shadow: inset 0 4px 15px rgba(255, 171, 64, 0.1);
    }

    .no-record .food-deco { font-size: 2.2em; margin: 0 12px; opacity: 0.7; }

    /* é£Ÿç‰©é»ç¶´ */
    .food-deco { font-size: 1.8em; margin: 0 10px; opacity: 0.65; vertical-align: middle; }

    /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
    .btn-delete {
      padding: 8px 16px;
      background: linear-gradient(to bottom, #ffcccc, #ff6b6b);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(255, 107, 107, 0.4);
      background: linear-gradient(to bottom, #ff9999, #ff4444);
    }

    .btn-delete:active {
      transform: translateY(0);
    }

    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 768px) {
      .search-section { flex-direction: column; gap: 15px; }
      .input-group, .filter-group { min-width: auto; }
      table { font-size: 0.95em; }
      th, td { padding: 15px 12px; }
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d4c0 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ===== ç¬¬1é  - é¦–é  ===== */
    .home-header {
      text-align: right;
      margin-bottom: 20px;
      font-size: 14px;
      color: #b89968;
    }

    .home-header a {
      color: #b89968;
      text-decoration: none;
      margin: 0 10px;
      cursor: pointer;
    }

    .home-header a:hover {
      text-decoration: underline;
    }

    .home-title {
      text-align: center;
      font-size: 48px;
      margin: 60px 0 30px;
      color: #5a3e2b;
    }

    .home-title .emoji {
      font-size: 60px;
      vertical-align: middle;
    }

    .home-description {
      text-align: center;
      line-height: 2;
      color: #6b4e3d;
      margin-bottom: 50px;
      font-size: 16px;
    }

    .btn-primary {
      display: block;
      margin: 0 auto;
      padding: 15px 60px;
      background: white;
      border: 2px solid #5a3e2b;
      border-radius: 50px;
      font-size: 20px;
      color: #5a3e2b;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: #5a3e2b;
      color: white;
    }

    /* ===== ç¬¬2é  - æŠ½å¡é é¢ ===== */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin: 40px 0;
    }

    .card {
      aspect-ratio: 2/3;
      position: relative;
      cursor: pointer;
      perspective: 1000px;
    }

    .card.selected {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }

    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .card-back {
      background: linear-gradient(135deg, #c84848 0%, #a03636 100%);
      border: 3px solid #8b2e2e;
    }

    .card-back::before,
    .card-back::after {
      content: '';
      position: absolute;
      width: 60%;
      height: 2px;
      background: rgba(0,0,0,0.3);
      transform: rotate(-25deg);
    }

    .card-back::after {
      transform: rotate(25deg);
    }

    .card-front {
      background: linear-gradient(135deg, #fff9f0 0%, #f5e6d3 100%);
      border: 3px solid #8b6f47;
      transform: rotateY(180deg);
    }

    .card-emoji {
      font-size: 60px;
      margin-bottom: 10px;
    }

    .card-name {
      font-size: 14px;
      color: #5a3e2b;
      font-weight: bold;
    }

    .shuffle-btn {
      display: block;
      margin: 20px auto;
      padding: 12px 40px;
      background: #ff9999;
      border: none;
      border-radius: 30px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shuffle-btn:hover {
      background: #ff7777;
      transform: scale(1.05);
    }

    .view-selection-btn {
      display: block;
      margin: 20px auto;
      padding: 12px 40px;
      background: #8b6f47;
      border: none;
      border-radius: 30px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .view-selection-btn:hover {
      background: #6b5537;
      transform: scale(1.05);
    }

    /* ===== ç¬¬3é  - é¸æ“‡å¡ç‰Œ ===== */
    .result-title {
      text-align: center;
      font-size: 32px;
      margin: 30px 0;
      color: #5a3e2b;
    }

    .meals-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
      margin: 40px 0;
    }

    .meal-slot {
      text-align: center;
    }

    .meal-label {
      font-size: 20px;
      margin-bottom: 15px;
      color: #5a3e2b;
      font-weight: bold;
    }

    .meal-card {
      width: 100%;
      aspect-ratio: 2/3;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d4c0 100%);
      border: 3px solid #8b6f47;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .meal-card.empty {
      background: #f0f0f0;
      border-style: dashed;
      color: #999;
    }

    .meal-card .card-emoji {
      font-size: 50px;
    }

    .meal-card .card-name {
      font-size: 16px;
      margin-top: 10px;
    }

    .meal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-redraw, .btn-remove, .btn-restore {
      padding: 8px 20px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-redraw {
      background: #ff9999;
      color: white;
    }

    .btn-remove {
      background: #ff4444;
      color: white;
    }

    .btn-restore {
      background: #66cc66;
      color: white;
    }

    .btn-view-result {
      display: block;
      margin: 40px auto;
      padding: 15px 50px;
      background: #8b6f47;
      border: none;
      border-radius: 30px;
      font-size: 20px;
      color: white;
      cursor: pointer;
    }

    /* ===== ç¬¬4é  - å åœçµæœ ===== */
    .result-page {
      background: linear-gradient(135deg, #5a3e2b 0%, #3d2817 100%);
      min-height: 100vh;
      padding: 40px 20px;
      margin: -20px;
    }

    .result-box {
      background: rgba(90, 62, 43, 0.8);
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      margin: 0 auto;
    }

    .result-title-white {
      text-align: center;
      font-size: 32px;
      color: white;
      margin-bottom: 30px;
    }

    .result-meals {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
    }

    .result-meal-item {
      text-align: center;
      color: white;
    }

    .result-card {
      width: 120px;
      height: 180px;
      background: linear-gradient(135deg, #fff9f0 0%, #f5e6d3 100%);
      border: 3px solid #8b6f47;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .result-card .card-emoji {
      font-size: 50px;
    }

    .result-meal-name {
      font-size: 14px;
      margin-top: 5px;
    }

    .result-food-name {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
    }

    .fortune-text {
      color: white;
      line-height: 2;
      margin: 30px 0;
      text-align: center;
      font-size: 16px;
    }

    .result-actions {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 40px;
    }

    .btn-share, .btn-save {
      padding: 12px 30px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-share {
      background: #ff4444;
      color: white;
    }

    .btn-save {
      background: #ff4444;
      color: white;
    }

    /* ===== Modal ç™»å…¥/è¨»å†Š ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
    }

    .modal-title {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
      color: #5a3e2b;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #5a3e2b;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    .btn-submit {
      width: 100%;
      padding: 12px;
      background: #8b6f47;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    .modal-footer {
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
    }

    .modal-footer a {
      color: #8b6f47;
      cursor: pointer;
      text-decoration: underline;
    }

    /* ç¤¾ç¾¤åˆ†äº«ç¾ç·¨ */
    .social-icons {
      display: flex;
      justify-content: center;
      gap: 25px; /* èª¿æ•´é–“è·ï¼Œè®“æ›´èˆ’é© */
      margin: 25px 0;
      flex-wrap: wrap; /* è¡Œå‹•è£ç½®è‡ªå‹•æ›è¡Œ */
    }

    .social-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      transition: transform 0.3s ease, opacity 0.3s ease;
      cursor: pointer;
    }

    .social-link:hover {
      transform: translateY(-5px) scale(1.05); /* hoveræ™‚è¼•å¾®æµ®èµ·å’Œæ”¾å¤§ */
      opacity: 0.9;
    }

    .social-icon {
      width: 60px; /* ç¨å¤§ä¸€é»ï¼Œæå‡è¦–è¦ºç„¦é» */
      height: 60px;
      border-radius: 50%; /* åœ“å½¢é‚Šæ¡†ï¼Œç¾ä»£æ„Ÿ */
      background: rgba(255, 255, 252, 0.95); /* åŒ¹é…ç¶²é èƒŒæ™¯ï¼Œæº«æš–ç±³é»ƒ */
      box-shadow: 0 4px 12px rgba(161, 117, 87, 0.15); /* è¼•æŸ”é™°å½± */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden; /* é˜²æ­¢åœ–ç¤ºæº¢å‡º */
      transition: box-shadow 0.3s ease, background 0.3s ease;
    }

    .social-link:hover .social-icon {
      box-shadow: 0 8px 20px rgba(255, 171, 64, 0.3); /* hoveræ™‚åŠ å¼·é™°å½±ï¼Œæš–æ©™è‰² */
      background: rgba(255, 240, 220, 0.8); /* è¼•å¾®è®Šè‰²ï¼Œå‘¼æ‡‰ä¸»é¡Œ */
    }

    .social-icon img {
      width: 40px; /* å…§éƒ¨åœ–ç¤ºå¤§å°ï¼Œç•™ç™½é‚Šè· */
      height: 40px;
      object-fit: contain; /* ç¢ºä¿åœ–ç¤ºä¸è®Šå½¢ */
    }

    /* å¹³å°ç‰¹å®šé¡è‰²èª¿æ•´ï¼ˆå¯é¸ï¼Œå¢å¼ºè­˜åˆ¥åº¦ï¼‰ */
    .social-icon.instagram {
      border: 2px solid #E1306C; /* IGç²‰ç´… */
    }

    .social-icon.facebook {
      border: 2px solid #1877F2; /* FBè— */
    }

    .social-icon.x-twitter {
      border: 2px solid #000000; /* Xé»‘ */
    }

    .social-label {
      margin-top: 8px;
      font-size: 14px;
      color: #6d4c41; /* åŒ¹é…ç¶²é æ–‡å­—è‰² */
      font-weight: 500;
      opacity: 0.9;
      transition: color 0.3s ease;
    }

    .social-link:hover .social-label {
      color: #ffab40; /* hoveræ™‚è®Šæˆæš–æ©™ï¼Œå¢åŠ äº’å‹•æ„Ÿ */
    }

    /* éŸ¿æ‡‰å¼èª¿æ•´ */
    @media (max-width: 768px) {
      .social-icons {
        gap: 15px;
      }
      .social-icon {
        width: 50px;
        height: 50px;
      }
      .social-icon img {
        width: 30px;
        height: 30px;
      }
      .social-label {
        font-size: 12px;
      }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    
    <!-- ç¬¬1é ï¼šé¦–é  -->
    <div id="page1" class="page active">
      <div class="home-header">
        <a onclick="showLogin()">æœƒå“¡ç™»å…¥</a> |
        <a onclick="showRegister()">æœƒå“¡è¨»å†Š</a> |
        <a onclick="showHistory()">æ­·å²æŸ¥è©¢</a>
      </div>
      
      <h1 class="home-title">
        é£Ÿç‰©å åœ <span class="emoji">ğŸ”®</span>
      </h1>
      
      <div class="home-description">
        æˆ‘å€‘ä»¥æº«æš–ã€å¹½é»˜ä¸”è²¼è¿‘ç”Ÿæ´»çš„æ–‡å­—,è®“ä½ åœ¨é¸æ“‡é£Ÿç‰©çš„éç¨‹ä¸­æ„Ÿ<br>
        å—åˆ°é™ªä¼´èˆ‡ç†è§£ã€‚é€éé£²é£Ÿèˆ‡é‹å‹¢çš„æ·±åº¦é€£çµ,ã€Œä»Šå¤©åƒä»€éº¼ã€ä¸<br>
        å†åªæ˜¯ç”Ÿç†éœ€æ±‚çš„æŠ‰æ“‡,è€Œæ˜¯ä¸€å ´æ¢ç´¢è‡ªæˆ‘ç‹€æ…‹çš„æ—¥å¸¸å°å„€å¼ã€‚<br><br>
        æ•´é«”é¢¨æ ¼ä¸»æ‰“è¼•é¬†ç™‚ç™’,å°ˆç‚ºå­¸ç”Ÿèˆ‡å¹´è¼•æ—ç¾¤è¨­è¨ˆ,è®“æ¯ä¸€å£é£Ÿç‰©<br>
        éƒ½æˆç‚ºæ›¿ç”Ÿæ´»å¢æ·»è¶£å‘³èˆ‡æœŸå¾…çš„èµ·é»ã€‚
      </div>
      
      <button class="btn-primary" onclick="goToPage(2)">é–‹å§‹å åœ</button>
    </div>

    <!-- ç¬¬2é ï¼šæŠ½å¡é é¢ -->
    <div id="page2" class="page">
      <h2 class="result-title">é¸æ“‡ä½ çš„ä¸‰é¤</h2>
      
      <div class="cards-grid" id="cardsGrid">
        <!-- å¡ç‰Œå°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
      
      <button class="shuffle-btn" onclick="shuffleCards()">æ´—ç‰Œ</button>
      <button class="view-selection-btn" onclick="goToPage(3)">æŒ‘é¸å¡ç‰‡</button>
    </div>

    <!-- ç¬¬3é ï¼šé¸æ“‡å¡ç‰Œ -->
    <div id="page3" class="page">
      <h2 class="result-title">æ‚¨çš„å åœçµæœ</h2>
      
      <div class="meals-container">
        <div class="meal-slot">
          <div class="meal-label">æ—©é¤</div>
          <div class="meal-card" id="breakfastCard">
            <span style="color: #999;">å°šæœªé¸æ“‡</span>
          </div>
          <div class="meal-buttons">
            <button class="btn-redraw" onclick="redrawMeal('breakfast')">é‡æŠ½</button>
            <button class="btn-remove" id="breakfastRemove" onclick="toggleRemove('breakfast')">ç§»é™¤</button>
          </div>
        </div>

        <div class="meal-slot">
          <div class="meal-label">åˆé¤</div>
          <div class="meal-card" id="lunchCard">
            <span style="color: #999;">å°šæœªé¸æ“‡</span>
          </div>
          <div class="meal-buttons">
            <button class="btn-redraw" onclick="redrawMeal('lunch')">é‡æŠ½</button>
            <button class="btn-remove" id="lunchRemove" onclick="toggleRemove('lunch')">ç§»é™¤</button>
          </div>
        </div>

        <div class="meal-slot">
          <div class="meal-label">æ™šé¤</div>
          <div class="meal-card" id="dinnerCard">
            <span style="color: #999;">å°šæœªé¸æ“‡</span>
          </div>
          <div class="meal-buttons">
            <button class="btn-redraw" onclick="redrawMeal('dinner')">é‡æŠ½</button>
            <button class="btn-remove" id="dinnerRemove" onclick="toggleRemove('dinner')">ç§»é™¤</button>
          </div>
        </div>
      </div>
      
      <button class="btn-view-result" onclick="checkAndViewResult()">æŸ¥çœ‹çµæœ</button>
    </div>

    <!-- ç¬¬4é ï¼šå åœçµæœ -->
    <div id="page4" class="page">
      <div class="result-page">
        <div id="captureArea" class="result-box" style="background: rgba(90, 62, 43, 0.9); border-radius: 20px; padding: 40px; max-width: 600px; margin: 40px auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <h2 class="result-title-white" style="font-size: 36px; margin-bottom: 40px;">æ‚¨çš„é£Ÿç‰©å åœçµæœ</h2>
        
        <div class="result-meals" id="resultMealsDisplay" style="margin-bottom: 40px;">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
        
        <div class="fortune-text" id="fortuneText" style="font-size: 18px; line-height: 2.2; white-space: pre-wrap;">
          <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div style="text-align: center; margin-top: 40px; color: #ffd700; font-size: 14px;">
          ğŸŒŸ é£Ÿç‰©å åœ ğŸ”® | ä»Šå¤©åƒä»€éº¼,ç”±å®‡å®™æ±ºå®š
        </div>
      </div>
          
          <div class="result-actions">
            <button class="btn-share" onclick="shareResult()">åˆ†äº«çµæœ</button>
            <button class="btn-save" onclick="saveResult()">å„²å­˜çµæœ</button>
          </div>

          <div style="text-align: center; margin: 60px 0 20px;">
            <button class="btn" onclick="goToPage(1)" style="padding: 20px 50px; font-size: 1.5em; background: linear-gradient(to bottom, #ffcc80, #ffab40);">
              ğŸ  å›é¦–é ,å†å åœä¸€æ¬¡!
            </button>
            <p style="margin-top: 20px; color: #a1887f; font-size: 1.1em;">
              ä»Šå¤©çš„é£Ÿç‰©é‹å‹¢å·²è¨˜éŒ„åœ¨å®‡å®™ä¸­ ğŸŒŒ<br>
              æ˜å¤©å†ä¾†,çœ‹çœ‹æœ‰ä»€éº¼æ–°é©šå–œ~
            </p>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ç™»å…¥ Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">æœƒå“¡ç™»å…¥</h3>
      <div class="form-group">
        <label>å¸³è™Ÿ</label>
        <input type="text" id="loginUsername" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      </div>
      <button class="btn-submit" onclick="handleLogin()">ç™»å…¥</button>
      <div class="modal-footer">
        é‚„æ²’æœ‰å¸³è™Ÿ?<a onclick="closeModal('loginModal'); showRegister()">ç«‹å³è¨»å†Š</a><br>
        <a onclick="closeModal('loginModal')">é—œé–‰</a>
      </div>
    </div>
  </div>

  <!-- è¨»å†Š Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">æœƒå“¡è¨»å†Š</h3>
      <div class="form-group">
        <label>å¸³è™Ÿ</label>
        <input type="text" id="registerUsername" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="registerPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      </div>
      <button class="btn-submit" onclick="handleRegister()">è¨»å†Š</button>
      <div class="modal-footer">
        å·²æœ‰å¸³è™Ÿ?<a onclick="closeModal('registerModal'); showLogin()">ç«‹å³ç™»å…¥</a><br>
        <a onclick="closeModal('registerModal')">é—œé–‰</a>
      </div>
    </div>
  </div>

  <!-- åˆ†äº« Modal -->
  <div id="shareModal" class="modal">
    <div class="modal-content" style="max-width: 380px; text-align: center;">
      <h3 class="modal-title">åˆ†äº«ä½ çš„å åœçµæœ</h3>
      <p style="color: #6b4e3d; margin: 20px 0; font-size: 15px;">
        å°‡ä»Šå¤©çš„é£Ÿç‰©é‹å‹¢åˆ†äº«çµ¦æœ‹å‹å§~
      </p>

      <button class="btn-primary" onclick="copyPageLink()" style="width: 80%; margin: 15px auto; padding: 12px;">
        ğŸ“‹ è¤‡è£½ç¶²ç«™é€£çµ
      </button>

      <button class="btn-primary" onclick="downloadResultImage()" style="width: 80%; margin: 15px auto; padding: 12px; background: #ffd43b; color: #5a3e2b;">
        ğŸ–¼ï¸ ä¸‹è¼‰çµæœåœ–å¡
      </button>

      <div style="margin: 30px 0;">
        <span style="color: #8b6f47; font-size: 14px;">æˆ–ç›´æ¥åˆ†äº«åˆ°</span>
      </div>

      <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;" class="social-icons">
        <a class="social-link" onclick="shareToIG()">
          <div class="social-icon instagram">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" width="50" alt="Instagram">
          </div>
          <span class="social-label">Instagram</span>
        </a>
        <a class="social-link" onclick="shareToFB()">
          <div class="social-icon facebook">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" width="50" alt="Facebook">
          </div>
          <span class="social-label">Facebook</span>
        </a>
        <a class="social-link" onclick="shareToX()">
          <div class="social-icon x-twitter">
            <img src="https://www.google.com/s2/favicons?domain=x.com&sz=128" width="50" alt="X">
          </div>
          <span class="social-label">X</span>
        </a>
      </div>

      <div class="modal-footer" style="margin-top: 30px;">
        <a onclick="closeModal('shareModal')" style="color: #8b6f47; cursor: pointer;">é—œé–‰</a>
      </div>
    </div>
  </div>

  <!-- æ­·å²ç´€éŒ„ Modal -->
  <div id="historyModal" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; background: rgba(255,255,252,0.95); border-radius: 32px; box-shadow: 0 20px 50px rgba(161,117,87,0.25); padding: 0;">
      
      <div class="deco deco1">ğŸ“š</div>
      <div class="deco deco2">ğŸ•¯ï¸</div>
      <div class="deco deco3">ğŸŒ¸</div>
      <div class="deco deco4">â˜•</div>

      <div class="main-container" style="padding: 20px 0; position: relative;">
        <div class="container" style="box-shadow: none; background: transparent; padding: 20px;">
          <h1>å åœç´€éŒ„æŸ¥è©¢</h1>
          <p class="subtitle">è¼•é¬†å›é¡§ä½ çš„ç¾é£Ÿå‘½é‹ä¹‹æ—…<span class="food-deco">ğŸ”®</span></p>

          <div class="search-section">
            <div class="input-group">
              <label>ç›®å‰ç™»å…¥æœƒå“¡</label>
              <div id="currentMemberDisplay" style="padding: 16px 22px; background: rgba(255,255,255,0.8); border: 2px solid #d7ccc8; border-radius: 25px; font-size: 1.2em; color: #6d4c41; text-align: center;">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="filter-group">
              <label for="meal-filter">ç¯©é¸é¡¯ç¤ºé¤åˆ¥</label>
              <select id="meal-filter">
                <option value="">é¡¯ç¤ºå…¨éƒ¨ä¸‰é¤ç´€éŒ„</option>
                <option value="breakfast">åªé¡¯ç¤ºæœ‰æ—©é¤çš„ç´€éŒ„</option>
                <option value="lunch">åªé¡¯ç¤ºæœ‰åˆé¤çš„ç´€éŒ„</option>
                <option value="dinner">åªé¡¯ç¤ºæœ‰æ™šé¤çš„ç´€éŒ„</option>
              </select>
            </div>
          </div>

          <button class="btn" onclick="loadHistoryRecords()">ğŸ” æŸ¥çœ‹æˆ‘çš„ç´€éŒ„</button>

          <div class="records" id="records-area">
            <div class="no-record">
              <span class="food-deco">ğŸµ</span><br>
              é‚„æ²’æœ‰æ‰¾åˆ°ç´€éŒ„å‘¢~<br>
              å¿«å»å åœå¹¾æ¬¡,è®“æˆ‘å€‘ä¸€èµ·è¨˜éŒ„é‚£äº›æº«æš–çš„æ™‚åˆ»å§!
              <span class="food-deco">ğŸ“–</span>
            </div>
          </div>
        </div>
      </div>

      <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;" class="social-icons">
        <a class="social-link" onclick="shareToIG()">
          <div class="social-icon instagram">
            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" width="50" alt="Instagram">
          </div>
          <span class="social-label">Instagram</span>
        </a>
        <a class="social-link" onclick="shareToFB()">
          <div class="social-icon facebook">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" width="50" alt="Facebook">
          </div>
          <span class="social-label">Facebook</span>
        </a>
        <a class="social-link" onclick="shareToX()">
          <div class="social-icon x-twitter">
            <img src="https://www.google.com/s2/favicons?domain=x.com&sz=128" width="50" alt="X">
          </div>
          <span class="social-label">X</span>
        </a>
      </div>

      <div style="text-align: center; padding: 10px 20px; background: rgba(255,255,255,0.5);">
        <a onclick="closeModal('historyModal')" style="color: #8d5524; cursor: pointer; text-decoration: underline; font-size: 1.1em;">é—œé–‰è¦–çª—</a>
      </div>
    </div>
  </div>

  <script>
    // ===== å…¨åŸŸè®Šæ•¸ =====
    let allCards = [];
    let selectedMeals = {
      breakfast: null,
      lunch: null,
      dinner: null
    };
    let removedMeals = {
      breakfast: false,
      lunch: false,
      dinner: false
    };
    let currentUser = null;

    //=========================================
    const API_URL = 'ä½ çš„GAS exec URL è²¼é€™è£¡';
    //=========================================

    // Emoji å°æ‡‰è¡¨
    const emojiMap = {
      'icon-egg-roll': 'ğŸ¥™',
      'icon-oatmeal': 'ğŸ¥£',
      'icon-beef-noodle': 'ğŸœœ',
      'icon-salad': 'ğŸ¥—',
      'icon-boba-tea': 'ğŸ§‹',
      'icon-braised-pork': 'ï¿½',
      'icon-coffee': 'â˜•',
      'icon-oden': 'ğŸ¢¢',
      'icon-fried-chicken': 'ğŸ——',
      'icon-onigiri': 'ğŸ™™',
      'icon-hotpot': 'ğŸ²²',
      'icon-yogurt': 'ğŸ¨¨',
      'icon-toast': 'ğŸ',
      'icon-pasta': 'ğŸ',
      'icon-fruit': 'ğŸ',
      'icon-bibimbap': 'ğŸšš',
      'icon-donut': 'ğŸ©©',
      'icon-rice-bowl': 'ğŸ±±',
      'icon-iced-coffee': 'ğŸ§Š',
      'icon-miso-soup': 'ğŸµµ'
    };
    
    async function callApi(functionName, params = {}) {
      const response = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ functionName, ...params })
      });
      return await response.json();
    }

    // ===== é é¢åˆ‡æ› =====
    function goToPage(pageNum) {
      if (pageNum === 3 || pageNum === 4) {
        const selectedCount = Object.keys(selectedMeals).filter(key => selectedMeals[key] !== null && !removedMeals[key]).length;
        if (selectedCount === 0) {
          alert('è«‹è‡³å°‘é¸æ“‡ä¸€é¤å–”~');
          return;
        }
      }

      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById('page' + pageNum).classList.add('active');
      
      if (pageNum === 2) {
        setTimeout(() => {
          loadCards();
        }, 300);
      }
      
      if (pageNum === 4) {
        renderResultPage();
      }
    }

    function checkAndViewResult() {
      const selectedCount = Object.keys(selectedMeals).filter(key => selectedMeals[key] !== null && !removedMeals[key]).length;
      if (selectedCount === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€é¤æ‰èƒ½æŸ¥çœ‹çµæœå–”~');
        return;
      }
      goToPage(4);
    }

    // ===== è¼‰å…¥å¡ç‰Œ(é˜² google æœªè¼‰å…¥) =====
    async function drawRandomCards() {
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ functionName: 'drawRandomCards' })  // å‚³ functionName å‘Šè¨´å¾Œç«¯åŸ·è¡Œå“ªå€‹
        });
        if (!response.ok) throw new Error('API éŒ¯èª¤');
        const data = await response.json();
        return data;  // è¿”å› 11 å¼µå¡ç‰Œé™£åˆ—
      } catch (error) {
        console.error('æŠ½å¡å¤±æ•—:', error);
        alert('æŠ½å¡å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ï½');
        return [];
      }
    }

    // ===== æ¸²æŸ“å¡ç‰Œ =====
    function renderCards() {
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML = '';
      
      allCards.forEach((food, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-index', index);
        
        card.innerHTML = `
          <div class="card-inner">
            <div class="card-face card-back">
              <div style="font-size:80px;">ğŸ½ï¸</div>
              <div style="font-size:14px; margin-top:10px; color:rgba(255,255,255,0.8);">é£Ÿç‰©å åœå¡</div>
            </div>
            <div class="card-face card-front">
              <div class="card-emoji">${emojiMap[food.image_ref] || 'ğŸ´´'}</div>
              <div class="card-name">${food.food_name}</div>
            </div>
          </div>
        `;
        
        card.onclick = function() {
          if (card.classList.contains('flipped')) return;
          
          card.classList.add('flipped');
          
          setTimeout(() => {
            selectCard(food, index);
          }, 600);
        };
        
        grid.appendChild(card);
      });
    }

    // ===== é¸æ“‡å¡ç‰Œ =====
    function selectCard(food, index) {
      const selectedCount = Object.keys(selectedMeals).filter(key => selectedMeals[key] !== null).length;
      
      if (selectedCount >= 3) {
        alert('ä¸‰é¤å·²é¸æ»¿!è«‹æŒ‰ã€ŒæŒ‘é¸å¡ç‰‡ã€ç¹¼çºŒ~');
        document.querySelector(`[data-index="${index}"]`).classList.remove('flipped');
        return;
      }
      
      let mealType = null;
      if (!selectedMeals.breakfast) mealType = 'breakfast';
      else if (!selectedMeals.lunch) mealType = 'lunch';
      else if (!selectedMeals.dinner) mealType = 'dinner';
      
      selectedMeals[mealType] = food;
      updateMealCard(mealType, food);
      
      const mealName = mealType === 'breakfast' ? 'æ—©é¤' : mealType === 'lunch' ? 'åˆé¤' : 'æ™šé¤';
      alert(`å·²ç‚º ${mealName} é¸æ“‡:${food.food_name} âœ¨`);
      
      if (Object.keys(selectedMeals).filter(key => selectedMeals[key] !== null).length === 3) {
        setTimeout(() => {
          if (confirm('ä¸‰é¤éƒ½é¸å¥½äº†!è¦ç«‹åˆ»æŸ¥çœ‹æŒ‘é¸çµæœå—?')) {
            goToPage(3);
          }
        }, 300);
      }
    }

    // ===== æ›´æ–°ç¬¬3é é¡¯ç¤º =====
    function updateMealCard(mealType, food) {
      const cardElement = document.getElementById(mealType + 'Card');
      if (food) {
        cardElement.innerHTML = `
          <div class="card-emoji">${emojiMap[food.image_ref] || 'ğŸ´´'}</div>
          <div class="card-name">${food.food_name}</div>
        `;
        cardElement.classList.remove('empty');
      } else {
        cardElement.innerHTML = '<span style="color: #999;">å°šæœªé¸æ“‡</span>';
        cardElement.classList.add('empty');
      }
    }

    // ===== æ´—ç‰Œ =====
    function shuffleCards() {
      selectedMeals = { breakfast: null, lunch: null, dinner: null };
      removedMeals = { breakfast: false, lunch: false, dinner: false };
      
      ['breakfast', 'lunch', 'dinner'].forEach(type => {
        updateMealCard(type, null);
        const btn = document.getElementById(type + 'Remove');
        if (btn) {
          btn.textContent = 'ç§»é™¤';
          btn.className = 'btn-remove';
        }
      });
      
      loadCards();
      alert('ç‰Œå·²é‡æ–°æ´—å¥½!è«‹é–‹å§‹æŠ½å¡ğŸ”®');
    }

    // ===== é‡æŠ½ =====
    function redrawMeal(mealType) {
      selectedMeals[mealType] = null;
      updateMealCard(mealType, null);
      goToPage(2);
      const mealName = mealType === 'breakfast' ? 'æ—©é¤' : mealType === 'lunch' ? 'åˆé¤' : 'æ™šé¤';
      alert(`è«‹é‡æ–°æŠ½å–${mealName}~`);
    }

    // ===== ç§»é™¤/å›å¾© =====
    function toggleRemove(mealType) {
      const button = document.getElementById(mealType + 'Remove');
      const cardElement = document.getElementById(mealType + 'Card');
      const label = cardElement.previousElementSibling;
      
      if (removedMeals[mealType]) {
        removedMeals[mealType] = false;
        button.textContent = 'ç§»é™¤';
        button.className = 'btn-remove';
        cardElement.style.display = 'flex';
        label.style.display = 'block';
      } else {
        removedMeals[mealType] = true;
        button.textContent = 'å›å¾©';
        button.className = 'btn-restore';
        cardElement.style.display = 'none';
        label.style.display = 'none';
      }
    }

    // ===== æ¸²æŸ“çµæœé é¢ =====
    function renderResultPage() {
      const resultDisplay = document.getElementById('resultMealsDisplay');
      const fortuneText = document.getElementById('fortuneText');
      
      resultDisplay.innerHTML = '';
      let fortunes = [];
      
      const mealTypes = ['breakfast', 'lunch', 'dinner'];
      const mealLabels = { breakfast: 'æ—©é¤', lunch: 'åˆé¤', dinner: 'æ™šé¤' };
      
      mealTypes.forEach(mealType => {
        if (!removedMeals[mealType] && selectedMeals[mealType]) {
          const food = selectedMeals[mealType];
          
          resultDisplay.innerHTML += `
            <div class="result-meal-item">
              <div class="result-card">
                <div class="card-emoji">${emojiMap[food.image_ref] || 'ğŸ´´'}</div>
              </div>
              <div class="result-meal-name">${mealLabels[mealType]}</div>
              <div class="result-food-name">${food.food_name}</div>
            </div>
          `;
          
          fortunes.push('<strong>' + food.fortune_label + '</strong>:' + food.interpretation + '<br>' + food.lucky_advice);
        }
      });
      
      fortuneText.innerHTML = fortunes.join('<br><br>') || 'ä»Šå¤©æ²’æœ‰é¸æ“‡ä»»ä½•é¤é»å–”~';
    }

    // ===== åˆ†äº«çµæœ Modal =====
    function shareResult() {
      document.getElementById('shareModal').classList.add('active');
    }

    function copyPageLink() {
      const url = window.location.href;
      
      navigator.clipboard.writeText(url).then(function() {
        alert('ğŸ”— ç¶²ç«™é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿!\nå¿«å»è²¼çµ¦æœ‹å‹ä¸€èµ·ç©~');
      }).catch(function() {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('ğŸ”— ç¶²ç«™é€£çµå·²è¤‡è£½!');
      });
    }

    function shareToIG() {
      const url = encodeURIComponent(window.location.href);
      const text = encodeURIComponent('æˆ‘å‰›ç”¨é£Ÿç‰©å åœæŠ½åˆ°ä»Šå¤©çš„é‹å‹¢!è¶…æº–çš„~ä½ ä¹Ÿä¾†è©¦è©¦!ğŸœœğŸ”®');
      window.open(`https://www.instagram.com/?url=${url}&text=${text}`, '_blank');
    }

    function shareToFB() {
      const url = encodeURIComponent(window.location.href);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
    }

    function shareToX() {
      const url = encodeURIComponent(window.location.href);
      const text = encodeURIComponent('ä»Šå¤©ç”¨é£Ÿç‰©å åœæŠ½ä¸‰é¤,çµæœè¶…æœ‰è¶£!ğŸ²² ä½ ä¹Ÿä¾†ç©~');
      window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
    }

    async function saveResult() {
  if (!currentUser) return showLogin();
  const response = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      functionName: 'saveFortuneResult',
      userId: currentUser.userId,
      breakfast: selectedMeals.breakfast,
      lunch: selectedMeals.lunch,
      dinner: selectedMeals.dinner
    })
  });
  const res = await response.json();
  alert(res.success ? 'çµæœå·²å„²å­˜ï¼' : res.message);
}

    // Modal
    function showLogin() { document.getElementById('loginModal').classList.add('active'); }
    function showRegister() { document.getElementById('registerModal').classList.add('active'); }
    function showHistory() {
      if (!currentUser) {
        alert('è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ­·å²ç´€éŒ„å–”~');
        showLogin();
        return;
      }

      console.log('ç›®å‰ç™»å…¥ userId:', currentUser.userId);

      document.getElementById('currentMemberDisplay').textContent = currentUser.username;

      document.getElementById('records-area').innerHTML = `
        <div class="no-record">
          <span class="food-deco">â³</span><br>
          æ­£åœ¨å–šé†’ä½ çš„å åœè¨˜æ†¶...<br>
          è«‹ç¨ç­‰ä¸€ä¸‹~
        </div>
      `;

      document.getElementById('historyModal').classList.add('active');
      
      loadHistoryRecords();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    async function handleLogin() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!username || !password) return alert('è«‹å¡«å¯«å®Œæ•´');

  const response = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ functionName: 'loginUser', username, password })
  });
  const res = await response.json();
  if (res.success) {
    currentUser = res;
    alert('ç™»å…¥æˆåŠŸï¼');
    closeModal('loginModal');
  } else {
    alert(res.message);
  }
}

    function handleRegister() {
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      if (!username || !password) return alert('è«‹å¡«å¯«å®Œæ•´');
      
      const res = await callApi('loginUser', { username, password });
        .registerUser(username, password);
    }

    async function loadHistoryRecords() {
  if (!currentUser) return showLogin();
  const response = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ functionName: 'getUserHistory', userId: currentUser.userId })
  });
  const records = await response.json();
  renderHistoryRecords(records || []);
}

    // ===== ã€æ–°å¢ã€‘åˆªé™¤ç´€éŒ„åŠŸèƒ½ =====
    async function deleteRecord(recordId) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å åœç´€éŒ„å—ï¼Ÿ\nåˆªé™¤å¾Œç„¡æ³•æ¢å¾©å–”ï½')) {
        return;  // ä½¿ç”¨è€…å–æ¶ˆ
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },641
          body: JSON.stringify({
            functionName: 'deleteHistoryRecord',  // å°æ‡‰ code.gs çš„å‡½æ•¸å
            recordId: recordId
          })
        });

        const res = await response.json();

        if (res.success) {
          alert('ç´€éŒ„å·²æˆåŠŸåˆªé™¤ï¼');
          loadHistoryRecords();  // é‡æ–°è¼‰å…¥æ­·å²ç´€éŒ„ï¼ˆæˆ– loadHistory() å¦‚æœæ˜¯å¾Œå°ï¼‰
        } else {
          alert('åˆªé™¤å¤±æ•—ï¼š' + (res.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (error) {
        console.error('åˆªé™¤è«‹æ±‚å¤±æ•—:', error);
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ï½');
      }
    }

    function renderHistoryRecords(records) {
      const area = document.getElementById('records-area');
      if (!records || !Array.isArray(records)) {
        area.innerHTML = `
          <div class="no-record">
            <span class="food-deco">ğŸ˜¿</span><br>
            è¼‰å…¥å¤±æ•—æˆ–ç„¡ç´€éŒ„~<br>
            è«‹ç¢ºèªæ˜¯å¦æœ‰å„²å­˜éå åœçµæœ,æˆ–å†è©¦ä¸€æ¬¡!
          </div>
        `;
        return;
      }

      const mealFilter = document.getElementById('meal-filter').value;

      const filtered = records.filter(record => {
        if (!mealFilter) return true;
        return record[mealFilter] !== undefined && record[mealFilter] !== null;
      });

      if (filtered.length === 0) {
        const mealName = mealFilter === 'breakfast' ? 'æ—©é¤' : 
                         mealFilter === 'lunch' ? 'åˆé¤' : 'æ™šé¤';
        area.innerHTML = `
          <div class="no-record">
            <span class="food-deco">ğŸŒ™</span><br>
            ç›®å‰æ²’æœ‰${mealFilter ? 'åŒ…å«ã€Œ' + mealName + 'ã€çš„' : ''}å åœç´€éŒ„~<br>
            å¿«å»å¤šå åœå¹¾æ¬¡å§!æˆ‘å€‘æœƒå¹«ä½ è¨˜éŒ„æ¯ä¸€é¤çš„ç¾å¥½
            <span class="food-deco">âœ¨</span>
          </div>
        `;
        return;
      }

      let tableHTML = `
        <div class="records-header">
          <span>æ‰¾åˆ° <strong>${filtered.length}</strong> ç­†æº«æš–ç´€éŒ„</span>
          <span class="record-count">æœ€æ–°å„ªå…ˆ</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>å åœæ—¥æœŸ</th>
              <th>ä¸‰é¤çµ„åˆ</th>
              <th>é‹å‹¢æ¨™èª</th>
              <th>è©³ç´°è§£è®€</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
      `;

      filtered.sort((a, b) => {
        const dateA = String(a.date || '');
        const dateB = String(b.date || '');
        return dateB.localeCompare(dateA);
      });

      filtered.forEach(record => {
        const meals = [];
        ['breakfast', 'lunch', 'dinner'].forEach(meal => {
          const mealName = meal === 'breakfast' ? 'æ—©é¤' : meal === 'lunch' ? 'åˆé¤' : 'æ™šé¤';
          if (record[meal] && record[meal].food_name) {
            meals.push(`<strong>${mealName}</strong>:${record[meal].food_name}`);
          } else {
            meals.push(`<strong>${mealName}</strong>:å°šæœªé¸æ“‡`);
          }
        });

        const labels = ['breakfast', 'lunch', 'dinner']
          .map(meal => record[meal]?.fortune_label || '')
          .filter(l => l)
          .join(' â‹… ');

        tableHTML += `
          <tr>
            <td>${record.date}</td>
            <td>${meals.join('<br>')}</td>
            <td>${labels || 'ç„¡æ¨™èª'}</td>
            <td style="font-size:0.9em; line-height:1.6;">${labels ? 'é‹å‹¢å°å‘:' + labels : 'å°šæœªè§£è®€'}</td>
            <td>
              <button class="btn-delete" onclick="deleteRecord('${record.record_id}')">
                ğŸ—‘ï¸ åˆªé™¤
              </button>
            </td>
          </tr>
        `;
      });

      tableHTML += `
          </tbody>
        </table>
      `;
      area.innerHTML = tableHTML;
    }

    function getMoodIcon(label) {
      const map = {
        'æ¸…çˆ½å¥åº·': 'ğŸŒ¿',
        'è±ç››é£½è¶³': 'ğŸ²²',
        'é‡å£å‘³åˆºæ¿€': 'ğŸŒ¶ï¸',
        'éš¨æ©Ÿæ··æ²Œ': 'ğŸ²'
      };
      return Object.entries(map).find(([k]) => label.includes(k))?.[1] || 'ğŸ´´';
    }

    function downloadResultImage() {
      const page4Actions = document.querySelector('#page4 .result-actions');
      if (page4Actions) page4Actions.style.display = 'none';

      html2canvas(document.getElementById('captureArea'), {
        scale: 2,
        backgroundColor: null,
        logging: false,
        useCORS: true
      }).then(canvas => {
        if (page4Actions) page4Actions.style.display = 'flex';

        const link = document.createElement('a');
        link.download = 'é£Ÿç‰©å åœçµæœ_' + new Date().toISOString().slice(0,10) + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();

        alert('ğŸ‰ ç¾ç¾åœ–å¡å·²ä¸‹è¼‰!å»åˆ†äº«å§~');
      }).catch(err => {
        if (page4Actions) page4Actions.style.display = 'flex';
        alert('ç”¢ç”Ÿå¤±æ•—,å†è©¦ä¸€æ¬¡');
        console.error(err);
      });
    }

    document.querySelectorAll('.social-link').forEach(link => {
      link.addEventListener('click', () => {
        link.style.animation = 'pulse 0.3s'; // é»æ“Šæ™‚è„ˆå‹•æ•ˆæœ
      });
    });
  </script>
</body>
</html>