<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ç”¨é£Ÿç‰©å åœä»Šå¤©çš„é‹å‹¢ï¼é¸æ“‡ä½ çš„ä¸‰é¤ï¼Œæ¢ç´¢å°ˆå±¬æ–¼ä½ çš„ç¾é£Ÿå‘½é‹">
  <title>é£Ÿç‰©å åœ ğŸ”® - ä»Šå¤©åƒä»€éº¼ï¼Œç”±å®‡å®™æ±ºå®š</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d4c0 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ===== ç¬¬1é  - é¦–é  ===== */
    .home-header {
      text-align: right;
      margin-bottom: 20px;
      font-size: 14px;
      color: #b89968;
    }

    .home-header a {
      color: #b89968;
      text-decoration: none;
      margin: 0 10px;
      cursor: pointer;
    }

    .home-header a:hover {
      text-decoration: underline;
    }

    .home-title {
      text-align: center;
      font-size: 48px;
      margin: 60px 0 30px;
      color: #5a3e2b;
    }

    .home-title .emoji {
      font-size: 60px;
      vertical-align: middle;
    }

    .home-description {
      text-align: center;
      line-height: 2;
      color: #6b4e3d;
      margin-bottom: 50px;
      font-size: 16px;
    }

    .btn-primary {
      display: block;
      margin: 0 auto;
      padding: 15px 60px;
      background: white;
      border: 2px solid #5a3e2b;
      border-radius: 50px;
      font-size: 20px;
      color: #5a3e2b;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: #5a3e2b;
      color: white;
    }

    /* ===== ç¬¬2é  - æŠ½å¡é é¢ ===== */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin: 40px 0;
    }

    .card {
      aspect-ratio: 2/3;
      position: relative;
      cursor: pointer;
      perspective: 1000px;
    }

    .card.selected {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }

    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .card-back {
      background: linear-gradient(135deg, #c84848 0%, #a03636 100%);
      border: 3px solid #8b2e2e;
    }

    .card-back::before,
    .card-back::after {
      content: '';
      position: absolute;
      width: 60%;
      height: 2px;
      background: rgba(0,0,0,0.3);
      transform: rotate(-25deg);
    }

    .card-back::after {
      transform: rotate(25deg);
    }

    .card-front {
      background: linear-gradient(135deg, #fff9f0 0%, #f5e6d3 100%);
      border: 3px solid #8b6f47;
      transform: rotateY(180deg);
    }

    .card-emoji {
      font-size: 60px;
      margin-bottom: 10px;
    }

    .card-name {
      font-size: 14px;
      color: #5a3e2b;
      font-weight: bold;
    }

    .shuffle-btn {
      display: block;
      margin: 20px auto;
      padding: 12px 40px;
      background: #ff9999;
      border: none;
      border-radius: 30px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shuffle-btn:hover {
      background: #ff7777;
      transform: scale(1.05);
    }

    .view-selection-btn {
      display: block;
      margin: 20px auto;
      padding: 12px 40px;
      background: #8b6f47;
      border: none;
      border-radius: 30px;
      font-size: 18px;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .view-selection-btn:hover {
      background: #6b5537;
      transform: scale(1.05);
    }

    /* ===== ç¬¬3é  - é¸æ“‡å¡ç‰Œ ===== */
    .result-title {
      text-align: center;
      font-size: 32px;
      margin: 30px 0;
      color: #5a3e2b;
    }

    .meals-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
      margin: 40px 0;
    }

    .meal-slot {
      text-align: center;
    }

    .meal-label {
      font-size: 20px;
      margin-bottom: 15px;
      color: #5a3e2b;
      font-weight: bold;
    }

    .meal-card {
      width: 100%;
      aspect-ratio: 2/3;
      background: linear-gradient(135deg, #f5e6d3 0%, #e8d4c0 100%);
      border: 3px solid #8b6f47;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .meal-card.empty {
      background: #f0f0f0;
      border-style: dashed;
      color: #999;
    }

    .meal-card .card-emoji {
      font-size: 50px;
    }

    .meal-card .card-name {
      font-size: 16px;
      margin-top: 10px;
    }

    .meal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-redraw, .btn-remove, .btn-restore {
      padding: 8px 20px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-redraw {
      background: #ff9999;
      color: white;
    }

    .btn-remove {
      background: #ff4444;
      color: white;
    }

    .btn-restore {
      background: #66cc66;
      color: white;
    }

    .btn-view-result {
      display: block;
      margin: 40px auto;
      padding: 15px 50px;
      background: #8b6f47;
      border: none;
      border-radius: 30px;
      font-size: 20px;
      color: white;
      cursor: pointer;
    }

    /* ===== ç¬¬4é  - å åœçµæœ ===== */
    .result-page {
      background: linear-gradient(135deg, #5a3e2b 0%, #3d2817 100%);
      min-height: 100vh;
      padding: 40px 20px;
      margin: -20px;
    }

    .result-box {
      background: rgba(90, 62, 43, 0.8);
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      margin: 0 auto;
    }

    .result-title-white {
      text-align: center;
      font-size: 32px;
      color: white;
      margin-bottom: 30px;
    }

    .result-meals {
      display: flex;
      justify-content: space-around;
      margin-bottom: 30px;
    }

    .result-meal-item {
      text-align: center;
      color: white;
    }

    .result-card {
      width: 120px;
      height: 180px;
      background: linear-gradient(135deg, #fff9f0 0%, #f5e6d3 100%);
      border: 3px solid #8b6f47;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .result-card .card-emoji {
      font-size: 50px;
    }

    .result-meal-name {
      font-size: 14px;
      margin-top: 5px;
    }

    .result-food-name {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
    }

    .fortune-text {
      color: white;
      line-height: 2;
      margin: 30px 0;
      text-align: center;
      font-size: 16px;
    }

    .result-actions {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 40px;
    }

    .btn-share, .btn-save {
      padding: 12px 30px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-share {
      background: #ff4444;
      color: white;
    }

    .btn-save {
      background: #ff4444;
      color: white;
    }

    /* ===== Modal ç™»å…¥/è¨»å†Š ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
    }

    .modal-title {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
      color: #5a3e2b;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #5a3e2b;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }

    .btn-submit {
      width: 100%;
      padding: 12px;
      background: #8b6f47;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    .modal-footer {
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
    }

    .modal-footer a {
      color: #8b6f47;
      cursor: pointer;
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .cards-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .meals-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- ç¬¬1é ï¼šé¦–é  -->
    <div id="page1" class="page active">
      <div class="home-header">
        <a onclick="showLogin()">æœƒå“¡ç™»å…¥</a> |
        <a onclick="showRegister()">æœƒå“¡è¨»å†Š</a> |
        <a onclick="showHistory()">æ­·å²æŸ¥è©¢</a>
      </div>
      
      <h1 class="home-title">
        é£Ÿç‰©å åœ <span class="emoji">ğŸ”®</span>
      </h1>
      
      <div class="home-description">
        æˆ‘å€‘ä»¥æº«æš–ã€å¹½é»˜ä¸”è²¼è¿‘ç”Ÿæ´»çš„æ–‡å­—ï¼Œè®“ä½ åœ¨é¸æ“‡é£Ÿç‰©çš„éç¨‹ä¸­æ„Ÿ<br>
        å—åˆ°é™ªä¼´èˆ‡ç†è§£ã€‚é€éé£²é£Ÿèˆ‡é‹å‹¢çš„æ·±åº¦é€£çµï¼Œã€Œä»Šå¤©åƒä»€éº¼ã€ä¸<br>
        å†åªæ˜¯ç”Ÿç†éœ€æ±‚çš„æŠ‰æ“‡ï¼Œè€Œæ˜¯ä¸€å ´æ¢ç´¢è‡ªæˆ‘ç‹€æ…‹çš„æ—¥å¸¸å°å„€å¼ã€‚<br><br>
        æ•´é«”é¢¨æ ¼ä¸»æ‰“è¼•é¬†ç™‚ç™’ï¼Œå°ˆç‚ºå­¸ç”Ÿèˆ‡å¹´è¼•æ—ç¾¤è¨­è¨ˆï¼Œè®“æ¯ä¸€å£é£Ÿç‰©<br>
        éƒ½æˆç‚ºæ›¿ç”Ÿæ´»å¢æ·»è¶£å‘³èˆ‡æœŸå¾…çš„èµ·é»ã€‚
      </div>
      
      <button class="btn-primary" onclick="goToPage(2)">é–‹å§‹å åœ</button>
    </div>

    <!-- ç¬¬2é ï¼šæŠ½å¡é é¢ -->
    <div id="page2" class="page">
      <h2 class="result-title">é¸æ“‡ä½ çš„ä¸‰é¤</h2>
      
      <div class="cards-grid" id="cardsGrid">
        <!-- å¡ç‰Œå°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
      </div>
      
      <button class="shuffle-btn" onclick="shuffleCards()">æ´—ç‰Œ</button>
      <button class="view-selection-btn" onclick="goToPage(3)">æŒ‘é¸å¡ç‰‡</button>
    </div>

    <!-- ç¬¬3é ï¼šé¸æ“‡å¡ç‰Œ -->
    <div id="page3" class="page">
      <h2 class="result-title">æ‚¨çš„å åœçµæœ</h2>
      
      <div class="meals-container">
        <div class="meal-slot">
          <div class="meal-label">æ—©é¤</div>
          <div class="meal-card" id="breakfastCard">
            <span style="color: #999;">å°šæœªé¸æ“‡</span>
          </div>
          <div class="meal-buttons">
            <button class="btn-redraw" onclick="redrawMeal('breakfast')">é‡æŠ½</button>
            <button class="btn-remove" id="breakfastRemove" onclick="toggleRemove('breakfast')">ç§»é™¤</button>
          </div>
        </div>

        <div class="meal-slot">
          <div class="meal-label">åˆé¤</div>
          <div class="meal-card" id="lunchCard">
            <span style="color: #999;">å°šæœªé¸æ“‡</span>
          </div>
          <div class="meal-buttons">
            <button class="btn-redraw" onclick="redrawMeal('lunch')">é‡æŠ½</button>
            <button class="btn-remove" id="lunchRemove" onclick="toggleRemove('lunch')">ç§»é™¤</button>
          </div>
        </div>

        <div class="meal-slot">
          <div class="meal-label">æ™šé¤</div>
          <div class="meal-card" id="dinnerCard">
            <span style="color: #999;">å°šæœªé¸æ“‡</span>
          </div>
          <div class="meal-buttons">
            <button class="btn-redraw" onclick="redrawMeal('dinner')">é‡æŠ½</button>
            <button class="btn-remove" id="dinnerRemove" onclick="toggleRemove('dinner')">ç§»é™¤</button>
          </div>
        </div>
      </div>
      
      <button class="btn-view-result" onclick="goToPage(4)">æŸ¥çœ‹çµæœ</button>
    </div>

    <!-- ç¬¬4é ï¼šå åœçµæœ -->
    <div id="page4" class="page">
      <div class="result-page">
        <div class="result-box">
          <h2 class="result-title-white">æ‚¨çš„å åœçµæœ</h2>
          
          <div class="result-meals" id="resultMealsDisplay">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </div>
          
          <div class="fortune-text" id="fortuneText">
            <!-- å‹•æ…‹ç”Ÿæˆé–‹é‹å»ºè­° -->
          </div>
          
          <div class="result-actions">
            <button class="btn-share" onclick="shareResult()">åˆ†äº«çµæœ</button>
            <button class="btn-save" onclick="saveResult()">å„²å­˜çµæœ</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- ç™»å…¥ Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">æœƒå“¡ç™»å…¥</h3>
      <div class="form-group">
        <label>å¸³è™Ÿ</label>
        <input type="text" id="loginUsername" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="loginPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      </div>
      <button class="btn-submit" onclick="handleLogin()">ç™»å…¥</button>
      <div class="modal-footer">
        é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<a onclick="closeModal('loginModal'); showRegister()">ç«‹å³è¨»å†Š</a><br>
        <a onclick="closeModal('loginModal')">é—œé–‰</a>
      </div>
    </div>
  </div>

  <!-- è¨»å†Š Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title">æœƒå“¡è¨»å†Š</h3>
      <div class="form-group">
        <label>å¸³è™Ÿ</label>
        <input type="text" id="registerUsername" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ">
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="registerPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
      </div>
      <button class="btn-submit" onclick="handleRegister()">è¨»å†Š</button>
      <div class="modal-footer">
        å·²æœ‰å¸³è™Ÿï¼Ÿ<a onclick="closeModal('registerModal'); showLogin()">ç«‹å³ç™»å…¥</a><br>
        <a onclick="closeModal('registerModal')">é—œé–‰</a>
      </div>
    </div>
  </div>

  <script>
    // ===== é£Ÿç‰©è³‡æ–™åº«ï¼ˆç¡¬ç·¨ç¢¼ï¼Œé¿å…ä¾è³´å¤–éƒ¨ APIï¼‰=====
    const FOODS_DATABASE = [
      {food_id: 'F001', food_name: 'é®ªé­šè›‹é¤…', category_tags: 'æ—©é¤', fortune_label: 'å°ç¢ºå¹¸', interpretation: 'å±¤å±¤åŒ…è£¹çš„è›‹çš®ï¼Œè±¡å¾µä»Šå¤©æœƒæœ‰æ„å¤–çš„ä¿è­·èˆ‡å®‰å…¨æ„Ÿã€‚', lucky_advice: 'é©åˆèˆ‡è€æœ‹å‹å‚³å€‹è¨Šæ¯è¯çµ¡ã€‚', image_ref: 'icon-egg-roll'},
      {food_id: 'F002', food_name: 'æº«ç†±ç‡•éº¥ç²¥', category_tags: 'æ—©é¤', fortune_label: 'éœå¿ƒ', interpretation: 'æŸ”è»Ÿä¸”æº«æš–çš„è³ªåœ°ï¼Œæš—ç¤ºä»Šå¤©é©åˆæ…¢ç¯€å¥ï¼Œç©©å®šæƒ…ç·’æ˜¯é¦–è¦ä»»å‹™ã€‚', lucky_advice: 'ç©¿ä¸Šç±³è‰²ç³»çš„è¡£æœã€‚', image_ref: 'icon-oatmeal'},
      {food_id: 'F003', food_name: 'ç‰›è‚‰éºµ', category_tags: 'åˆé¤,æ™šé¤', fortune_label: 'å‹é“åè¶³', interpretation: 'å¸¶å‹çš„é¢æ¢è±¡å¾µä½ çš„æ„å¿—åŠ›ã€‚ä»Šå¤©é‡åˆ°çš„å›°é›£éƒ½èƒ½è¿åˆƒè€Œè§£ã€‚', lucky_advice: 'å–ä¸€å£ç†±æ¹¯å¾Œè¨±å€‹é¡˜ã€‚', image_ref: 'icon-beef-noodle'},
      {food_id: 'F004', food_name: 'èˆ’è‚¥é›è‚‰æ²™æ‹‰', category_tags: 'åˆé¤,æ™šé¤', fortune_label: 'è¼•ç›ˆè½‰æ©Ÿ', interpretation: 'æ“ºè„«æ²‰é‡çš„è² æ“”ï¼Œä»Šå¤©é©åˆé–‹å•Ÿæ–°çš„è¨ˆç•«æˆ–æ•´ç†ç’°å¢ƒã€‚', lucky_advice: 'é©åˆå»å…¬åœ’æ•£æ­¥ 10 åˆ†é˜ã€‚', image_ref: 'icon-salad'},
      {food_id: 'F005', food_name: 'çç å¥¶èŒ¶', category_tags: 'æ—©é¤,åˆé¤,æ™šé¤', fortune_label: 'åœ“æ»¿å¦‚æ„', interpretation: 'åœ“æ½¤çš„çç è±¡å¾µäº‹æƒ…å°‡æœ‰åœ“æ»¿çš„çµå±€ã€‚å£“åŠ›å¤§æ™‚åš¼ä¸€åš¼å°±å¥½ã€‚', lucky_advice: 'ä»Šå¤©çš„å¹¸é‹æ•¸å­—æ˜¯ 0ã€‚', image_ref: 'icon-boba-tea'},
      {food_id: 'F006', food_name: 'æ»·è‚‰é£¯', category_tags: 'åˆé¤,æ™šé¤', fortune_label: 'è¸å¯¦ç©©é‡', interpretation: 'æ¿ƒéƒçš„é†¬æ±è±¡å¾µæ·±åšçš„æ ¹åŸºï¼Œä»Šå¤©é©åˆè™•ç†é•·æœŸç©æ¬ çš„äº‹å‹™ã€‚', lucky_advice: 'å¤šé—œå¿ƒå®¶äººçš„è¿‘æ³ã€‚', image_ref: 'icon-braised-pork'},
      {food_id: 'F007', food_name: 'æ‹¿éµå’–å•¡', category_tags: 'æ—©é¤', fortune_label: 'éˆæ„Ÿçˆ†ç™¼', interpretation: 'å¥¶æ³¡èˆ‡å’–å•¡çš„èåˆï¼Œé ç¤ºè‘—ä»Šå¤©æœƒæœ‰è·¨é ˜åŸŸçš„æ–°é»å­ç”¢ç”Ÿã€‚', lucky_advice: 'éš¨èº«å¸¶ä¸€æœ¬ç­†è¨˜æœ¬ã€‚', image_ref: 'icon-coffee'},
      {food_id: 'F008', food_name: 'é—œæ±ç…®', category_tags: 'æ™šé¤', fortune_label: 'æº«æš–åŒ…å®¹', interpretation: 'å¤šæ¨£çš„é£Ÿæè±¡å¾µå¤šå…ƒçš„æ©Ÿæœƒï¼Œä»Šå¤©é©åˆåœ˜éšŠåˆä½œã€‚', lucky_advice: 'å˜—è©¦è½ä¸€é¦–æ²’è½éçš„æ­Œã€‚', image_ref: 'icon-oden'},
      {food_id: 'F009', food_name: 'è„†çš®ç‚¸é›', category_tags: 'åˆé¤,æ™šé¤', fortune_label: 'èƒ½é‡çˆ†ç™¼', interpretation: 'é…¥è„†çš„å¤–çš®åŒ…è£¹è‘—ç†±é¨°é¨°çš„åŠ›é‡ï¼Œè±¡å¾µä½ ä»Šå¤©çš„çªç ´é»å°±åœ¨ã€Œå‹‡æ°£ã€ã€‚', lucky_advice: 'é©åˆåœ¨æœƒè­°ä¸­ä¸»å‹•èˆ‰æ‰‹ç™¼è¨€ã€‚', image_ref: 'icon-fried-chicken'},
      {food_id: 'F010', food_name: 'æ—¥å¼é£¯ç³°', category_tags: 'æ—©é¤,åˆé¤', fortune_label: 'ç°¡ç´„ç”Ÿæ´»', interpretation: 'ç´”ç²¹çš„ç±³é£¯èˆ‡æµ·è‹”ï¼Œé ç¤ºä»Šå¤©é©åˆæ–·æ¨é›¢ï¼ŒåŒ–ç¹ç‚ºç°¡æœƒè®“ä½ æ›´è¼•é¬†ã€‚', lucky_advice: 'æ•´ç†ä¸€ä¸‹é›»è…¦æ¡Œé¢æˆ–éŒ¢åŒ…ã€‚', image_ref: 'icon-onigiri'},
      {food_id: 'F011', food_name: 'éº»è¾£ç«é‹', category_tags: 'æ™šé¤', fortune_label: 'ç†±æƒ…å¦‚ç«', interpretation: 'æ²¸é¨°çš„æ¹¯åº•ä»£è¡¨ä½ çš„äººéš›é—œä¿‚æ­£è¿…é€Ÿå‡æº«ï¼Œä½†ä¹Ÿè¨˜å¾—ä¿æŒé©åº¦è·é›¢ã€‚', lucky_advice: 'å–ä¸€æ¯å†°æ°´å†·éœæ€è€ƒã€‚', image_ref: 'icon-hotpot'},
      {food_id: 'F012', food_name: 'è—è“å„ªæ ¼', category_tags: 'æ—©é¤', fortune_label: 'æ˜äº®è¦–é‡', interpretation: 'é…¸ç”œçš„æ»‹å‘³æœ‰åŠ©æ–¼æ¸…é†’é ­è…¦ï¼Œä»Šå¤©é©åˆè™•ç†éœ€è¦é‚è¼¯åˆ†æçš„äº‹æƒ…ã€‚', lucky_advice: 'é çœºçª—å¤–ç¶ è‰²æ¤ç‰© 3 åˆ†é˜ã€‚', image_ref: 'icon-yogurt'},
      {food_id: 'F013', food_name: 'ç‚­çƒ¤åå¸', category_tags: 'æ—©é¤', fortune_label: 'æ‡·èˆŠæº«æš–', interpretation: 'ç‚­ç«çš„é¦™æ°£å–šé†’ç›´è¦ºï¼Œä»Šå¤©é©åˆå›é¡§éå»çš„ç¶“é©—ä¾†è§£æ±ºå•é¡Œã€‚', lucky_advice: 'æ‰“é–‹ç›¸ç°¿çœ‹çœ‹èˆŠç…§ç‰‡ã€‚', image_ref: 'icon-toast'},
      {food_id: 'F014', food_name: 'ç¾©å¤§åˆ©éºµ', category_tags: 'åˆé¤,æ™šé¤', fortune_label: 'æ¢ç†åˆ†æ˜', interpretation: 'äº¤ç¹”çš„éºµæ¢éœ€è¦è€å¿ƒæ¢³ç†ï¼Œä»Šå¤©è™•ç†ç‘£äº‹æ™‚è«‹ä¿æŒè€å¿ƒã€‚', lucky_advice: 'ç©¿ä¸Šæœ‰æ¢ç´‹åœ–æ¡ˆçš„è¡£ç‰©ã€‚', image_ref: 'icon-pasta'},
      {food_id: 'F015', food_name: 'ç¾åˆ‡æ°´æœç›¤', category_tags: 'æ—©é¤,åˆé¤', fortune_label: 'å¤šå½©å¥‘æ©Ÿ', interpretation: 'å„ç¨®é¡è‰²çš„æ°´æœä»£è¡¨å¤šæ¨£çš„æ©Ÿæœƒï¼Œä»Šå¤©ä¸æ‡‰è©²æ‹’çµ•ä»»ä½•æ–°å˜—è©¦ã€‚', lucky_advice: 'å˜—è©¦ä¸€æ¢æ²’èµ°éçš„å›å®¶è·¯ã€‚', image_ref: 'icon-fruit'},
      {food_id: 'F016', food_name: 'éŸ“å¼æ‹Œé£¯', category_tags: 'åˆé¤,æ™šé¤', fortune_label: 'å’Œè«§å…±ç”Ÿ', interpretation: 'å°‡ä¸åŒçš„é£Ÿææ”ªæ‹Œå‡å‹»ï¼Œæš—ç¤ºä»Šå¤©åœ˜éšŠåˆä½œæ˜¯æˆåŠŸçš„é—œéµã€‚', lucky_advice: 'é©åˆèˆ‡åŒäº‹ä¸€èµ·å…±é€²åˆé¤ã€‚', image_ref: 'icon-bibimbap'},
      {food_id: 'F017', food_name: 'ç”œç”œåœˆ', category_tags: 'æ—©é¤,åˆé¤,æ™šé¤', fortune_label: 'ç”œèœœå¾ªç’°', interpretation: 'åœ“åœˆé€ å‹è±¡å¾µå¥½é‹æœƒä¸æ–·å¾ªç’°å›åˆ°ä½ èº«é‚Šï¼Œä»Šå¤©æœƒæœ‰æ„å¤–çš„å°ç¢ºå¹¸ã€‚', lucky_advice: 'å°é¡å­è£¡çš„è‡ªå·±å¾®ç¬‘ä¸€ä¸‹ã€‚', image_ref: 'icon-donut'},
      {food_id: 'F018', food_name: 'ç‡’è‚‰ä¸¼é£¯', category_tags: 'åˆé¤,æ™šé¤', fortune_label: 'é£½æ»¿è‡ªä¿¡', interpretation: 'æ»¿æº¢å‡ºä¾†çš„è‚‰ç‰‡ä»£è¡¨ä½ çš„è‡ªä¿¡å¿ƒï¼Œä»Šå¤©é©åˆå‘å¿ƒå„€å°è±¡æˆ–å®¢æˆ¶ææ¡ˆã€‚', lucky_advice: 'æŒºèµ·èƒ¸è†›ï¼Œå¤§æ­¥èµ°è·¯ã€‚', image_ref: 'icon-rice-bowl'},
      {food_id: 'F019', food_name: 'å†°ç¾å¼', category_tags: 'æ—©é¤,åˆé¤', fortune_label: 'å†·éœæœæ±º', interpretation: 'å†°çˆ½ä¸”å¾®è‹¦çš„å‘³é“ï¼Œä»£è¡¨ä»Šå¤©éœ€è¦ä½ ä¿æŒç†æ€§ï¼Œä¸è¢«æƒ…ç·’å·¦å³ã€‚', lucky_advice: 'å¯«ä¸‹ä»Šå¤©æœ€é‡è¦çš„ä¸‰ä»¶äº‹ã€‚', image_ref: 'icon-iced-coffee'},
      {food_id: 'F020', food_name: 'è”¬èœå‘³å™Œæ¹¯', category_tags: 'æ—©é¤,æ™šé¤', fortune_label: 'ç™‚ç™’å¹³éœ', interpretation: 'æº«å’Œçš„ç™¼é…µå‘³é“èƒ½å®‰æ’«éˆé­‚ï¼Œä»Šå¤©é©åˆå°‹æ±‚å…§å¿ƒçš„å¹³éœã€‚', lucky_advice: 'æ™šä¸Šæ—© 30 åˆ†é˜ä¸ŠåºŠç¡è¦ºã€‚', image_ref: 'icon-miso-soup'}
    ];

    // ===== å…¨åŸŸè®Šæ•¸ =====
    let allCards = [];
    let selectedMeals = {
      breakfast: null,
      lunch: null,
      dinner: null
    };
    let removedMeals = {
      breakfast: false,
      lunch: false,
      dinner: false
    };
    let currentUser = null;

    // Emoji å°æ‡‰è¡¨
    const emojiMap = {
      'icon-egg-roll': 'ğŸ¥™',
      'icon-oatmeal': 'ğŸ¥£',
      'icon-beef-noodle': 'ğŸœ',
      'icon-salad': 'ğŸ¥—',
      'icon-boba-tea': 'ğŸ§‹',
      'icon-braised-pork': 'ğŸ›',
      'icon-coffee': 'â˜•',
      'icon-oden': 'ğŸ¢',
      'icon-fried-chicken': 'ğŸ—',
      'icon-onigiri': 'ğŸ™',
      'icon-hotpot': 'ğŸ²',
      'icon-yogurt': 'ğŸ¨',
      'icon-toast': 'ğŸ',
      'icon-pasta': 'ğŸ',
      'icon-fruit': 'ğŸ',
      'icon-bibimbap': 'ğŸš',
      'icon-donut': 'ğŸ©',
      'icon-rice-bowl': 'ğŸ±',
      'icon-iced-coffee': 'ğŸ§Š',
      'icon-miso-soup': 'ğŸµ'
    };

    // ===== LocalStorage è¼”åŠ©å‡½æ•¸ =====
    function saveToLocalStorage(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        return true;
      } catch (e) {
        console.error('LocalStorage å„²å­˜å¤±æ•—:', e);
        return false;
      }
    }

    function getFromLocalStorage(key) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error('LocalStorage è®€å–å¤±æ•—:', e);
        return null;
      }
    }

    // ===== é é¢åˆ‡æ› =====
    function goToPage(pageNum) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById('page' + pageNum).classList.add('active');
      
      if (pageNum === 2) {
        loadCards();
      }
      
      if (pageNum === 4) {
        renderResultPage();
      }
    }

    // ===== è¼‰å…¥å¡ç‰Œ =====
    function loadCards() {
      // å¾é£Ÿç‰©è³‡æ–™åº«éš¨æ©ŸæŠ½å– 11 å¼µ
      const shuffled = [...FOODS_DATABASE].sort(() => Math.random() - 0.5);
      allCards = shuffled.slice(0, 11);
      renderCards();
    }

    // ===== æ¸²æŸ“å¡ç‰Œ =====
    function renderCards() {
      const grid = document.getElementById('cardsGrid');
      grid.innerHTML = '';
      
      allCards.forEach((food, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-index', index);
        card.innerHTML = `
          <div class="card-inner">
            <div class="card-face card-back"></div>
            <div class="card-face card-front">
              <div class="card-emoji">${emojiMap[food.image_ref] || 'ğŸ´'}</div>
              <div class="card-name">${food.food_name}</div>
            </div>
          </div>
        `;
        
        card.addEventListener('click', function() {
          selectCard(index);
        });
        
        grid.appendChild(card);
      });
    }

    // ===== é¸æ“‡å¡ç‰Œ =====
    function selectCard(index) {
      const card = document.querySelector('[data-index="' + index + '"]');
      
      if (card.classList.contains('selected')) {
        return;
      }
      
      card.classList.add('flipped');
      card.classList.add('selected');
      
      const food = allCards[index];
      
      if (!selectedMeals.breakfast) {
        selectedMeals.breakfast = food;
        updateMealCard('breakfast', food);
      } else if (!selectedMeals.lunch) {
        selectedMeals.lunch = food;
        updateMealCard('lunch', food);
      } else if (!selectedMeals.dinner) {
        selectedMeals.dinner = food;
        updateMealCard('dinner', food);
      } else {
        alert('ä¸‰é¤å·²é¸æ»¿ï¼è«‹æŒ‰ã€ŒæŒ‘é¸å¡ç‰‡ã€æŸ¥çœ‹çµæœ');
      }
    }

    // ===== æ›´æ–°é¤åˆ¥å¡ç‰Œ =====
    function updateMealCard(mealType, food) {
      const cardElement = document.getElementById(mealType + 'Card');
      
      if (food) {
        cardElement.innerHTML = `
          <div class="card-emoji">${emojiMap[food.image_ref] || 'ğŸ´'}</div>
          <div class="card-name">${food.food_name}</div>
        `;
        cardElement.classList.remove('empty');
      } else {
        cardElement.innerHTML = '<span style="color: #999;">å°šæœªé¸æ“‡</span>';
        cardElement.classList.add('empty');
      }
    }

    // ===== æ´—ç‰Œ =====
    function shuffleCards() {
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        card.classList.remove('flipped', 'selected');
      });
    }

    // ===== é‡æŠ½ =====
    function redrawMeal(mealType) {
      selectedMeals[mealType] = null;
      updateMealCard(mealType, null);
      goToPage(2);
    }

    // ===== ç§»é™¤/å›å¾© =====
    function toggleRemove(mealType) {
      const button = document.getElementById(mealType + 'Remove');
      const cardElement = document.getElementById(mealType + 'Card');
      const label = cardElement.previousElementSibling;
      
      if (removedMeals[mealType]) {
        removedMeals[mealType] = false;
        button.textContent = 'ç§»é™¤';
        button.className = 'btn-remove';
        cardElement.style.display = 'flex';
        label.style.display = 'block';
      } else {
        removedMeals[mealType] = true;
        button.textContent = 'å›å¾©';
        button.className = 'btn-restore';
        cardElement.style.display = 'none';
        label.style.display = 'none';
      }
    }

    // ===== æ¸²æŸ“çµæœé é¢ =====
    function renderResultPage() {
      const resultDisplay = document.getElementById('resultMealsDisplay');
      const fortuneText = document.getElementById('fortuneText');
      
      resultDisplay.innerHTML = '';
      let fortunes = [];
      
      const mealTypes = ['breakfast', 'lunch', 'dinner'];
      const mealLabels = { breakfast: 'æ—©é¤', lunch: 'åˆé¤', dinner: 'æ™šé¤' };
      
      mealTypes.forEach(mealType => {
        if (!removedMeals[mealType] && selectedMeals[mealType]) {
          const food = selectedMeals[mealType];
          
          resultDisplay.innerHTML += `
            <div class="result-meal-item">
              <div class="result-card">
                <div class="card-emoji">${emojiMap[food.image_ref] || 'ğŸ´'}</div>
              </div>
              <div class="result-meal-name">${mealLabels[mealType]}</div>
              <div class="result-food-name">${food.food_name}</div>
            </div>
          `;
          
          fortunes.push('<strong>' + food.fortune_label + '</strong>ï¼š' + food.interpretation + '<br>' + food.lucky_advice);
        }
      });
      
      fortuneText.innerHTML = fortunes.join('<br><br>');
    }

    // ===== åˆ†äº«çµæœ =====
    function shareResult() {
      const text = 'æˆ‘å‰›ç”¨é£Ÿç‰©å åœæŠ½åˆ°ä»Šå¤©çš„é‹å‹¢ï¼è¶…æº–çš„ï½ä½ ä¹Ÿä¾†è©¦è©¦ï¼';
      const url = window.location.href;
      
      if (navigator.share) {
        navigator.share({
          title: 'é£Ÿç‰©å åœ',
          text: text,
          url: url
        }).then(() => {
          console.log('åˆ†äº«æˆåŠŸ');
        }).catch((error) => {
          console.log('åˆ†äº«å–æ¶ˆ', error);
        });
      } else {
        // å‚™ç”¨æ–¹æ¡ˆï¼šè¤‡è£½é€£çµ
        navigator.clipboard.writeText(url).then(() => {
          alert('é€£çµå·²è¤‡è£½ï¼å¿«å»åˆ†äº«çµ¦æœ‹å‹å§ï½');
        }).catch(() => {
          alert('åˆ†äº«åŠŸèƒ½ç›®å‰ä¸æ”¯æ´æ‚¨çš„ç€è¦½å™¨');
        });
      }
    }

    // ===== å„²å­˜çµæœ =====
    function saveResult() {
      if (!currentUser) {
        showLogin();
        alert('è«‹å…ˆç™»å…¥æ‰èƒ½å„²å­˜çµæœå–”ï½');
        return;
      }
      
      // å–å¾—ç¾æœ‰çš„æ­·å²è¨˜éŒ„
      let history = getFromLocalStorage('fortune_history') || [];
      
      // å»ºç«‹æ–°è¨˜éŒ„
      const record = {
        record_id: 'R' + Date.now(),
        user_id: currentUser.userId,
        date: new Date().toISOString().split('T')[0],
        breakfast: selectedMeals.breakfast ? {
          food_id: selectedMeals.breakfast.food_id,
          food_name: selectedMeals.breakfast.food_name,
          fortune_label: selectedMeals.breakfast.fortune_label
        } : null,
        lunch: selectedMeals.lunch ? {
          food_id: selectedMeals.lunch.food_id,
          food_name: selectedMeals.lunch.food_name,
          fortune_label: selectedMeals.lunch.fortune_label
        } : null,
        dinner: selectedMeals.dinner ? {
          food_id: selectedMeals.dinner.food_id,
          food_name: selectedMeals.dinner.food_name,
          fortune_label: selectedMeals.dinner.fortune_label
        } : null
      };
      
      history.push(record);
      
      if (saveToLocalStorage('fortune_history', history)) {
        alert('çµæœå·²å„²å­˜ï¼');
      } else {
        alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // ===== Modal æ§åˆ¶ =====
    function showLogin() {
      document.getElementById('loginModal').classList.add('active');
    }

    function showRegister() {
      document.getElementById('registerModal').classList.add('active');
    }

    function showHistory() {
      if (!currentUser) {
        alert('è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ­·å²è¨˜éŒ„å–”ï½');
        showLogin();
        return;
      }
      
      const history = getFromLocalStorage('fortune_history') || [];
      const userHistory = history.filter(record => record.user_id === currentUser.userId);
      
      if (userHistory.length === 0) {
        alert('é‚„æ²’æœ‰ä»»ä½•å åœè¨˜éŒ„å–”ï½å¿«å»å åœå§ï¼');
        return;
      }
      
      // é¡¯ç¤ºæ­·å²è¨˜éŒ„ï¼ˆç°¡å–®ç‰ˆæœ¬ï¼‰
      let historyText = 'æ‚¨çš„å åœæ­·å²ï¼š\n\n';
      userHistory.slice(-5).reverse().forEach(record => {
        historyText += `æ—¥æœŸï¼š${record.date}\n`;
        if (record.breakfast) historyText += `æ—©é¤ï¼š${record.breakfast.food_name} (${record.breakfast.fortune_label})\n`;
        if (record.lunch) historyText += `åˆé¤ï¼š${record.lunch.food_name} (${record.lunch.fortune_label})\n`;
        if (record.dinner) historyText += `æ™šé¤ï¼š${record.dinner.food_name} (${record.dinner.fortune_label})\n`;
        historyText += '\n';
      });
      
      alert(historyText);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ===== ç™»å…¥ =====
    function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
        return;
      }
      
      // å¾ LocalStorage å–å¾—æœƒå“¡è³‡æ–™
      const users = getFromLocalStorage('users') || [];
      const user = users.find(u => u.username === username && u.password === password);
      
      if (user) {
        currentUser = {
          userId: user.user_id,
          username: user.username
        };
        alert('ç™»å…¥æˆåŠŸï¼æ­¡è¿å›ä¾† ' + username);
        closeModal('loginModal');
      } else {
        alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
      }
    }

    // ===== è¨»å†Š =====
    function handleRegister() {
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      
      if (!username || !password) {
        alert('è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼');
        return;
      }
      
      // å¾ LocalStorage å–å¾—ç¾æœ‰æœƒå“¡
      let users = getFromLocalStorage('users') || [];
      
      // æª¢æŸ¥å¸³è™Ÿæ˜¯å¦å·²å­˜åœ¨
      if (users.some(u => u.username === username)) {
        alert('æ­¤å¸³è™Ÿå·²è¢«è¨»å†Š');
        return;
      }
      
      // å»ºç«‹æ–°æœƒå“¡
      const newUser = {
        user_id: 'U' + Date.now(),
        username: username,
        password: password,
        join_date: new Date().toISOString().split('T')[0]
      };
      
      users.push(newUser);
      
      if (saveToLocalStorage('users', users)) {
        alert('è¨»å†ŠæˆåŠŸï¼è«‹ç™»å…¥');
        closeModal('registerModal');
        showLogin();
      } else {
        alert('è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    // ===== åˆå§‹åŒ– =====
    window.onload = function() {
      console.log('é£Ÿç‰©å åœç³»çµ±å·²è¼‰å…¥');
    };
  </script>
</body>
</html>